<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano  System</title>
    <style>
        /* Styling for the big emoji */
        .emoji {
            font-size: 50px;
            text-align: center;
            margin: 20px 0;
        }
        .center-text {
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- Big Laughing Emoji and Message -->
    <div class="emoji">ðŸ˜‚</div>
    <h1 class="center-text">We will give a reward to see this emoji for one person!</h1>
    
    <!-- Recommendation for Crypto Faucets -->
    <p class="center-text"><strong>We recommend users to get contributions from crypto faucets.and this is demo project so no guarantee for nano and also use we recommend nault wallet for easy intergration and this is not lottery system and this will give users to chance to make 100x of thier faucet good luck all work is done manually </strong></p>

    <!-- User Wallet Connection -->
    <form id="walletForm" class="center-text">
        <label for="walletAddress">Enter your Nano wallet address:</label>
        <input type="text" id="walletAddress" name="walletAddress" required>
        <button type="submit">Connect</button>
    </form>

    <p id="userStatus" class="center-text">Please enter your wallet address to join the lottery.</p>

    <!-- Admin Wallet -->
    <p class="center-text">Admin Wallet Address: <strong>nano_3m1pir3qb3ciyxsupsmo3zf1t3f1yccx8pjokj97tk9ya4oq333h69utzu4f</strong></p>

    <!-- Lottery Info -->
    <button id="joinLottery" disabled>Join Lottery for 0.02 Nano</button>
    <p id="lotteryStatus" class="center-text">Participants: 0/100</p>

    <script>
        // Global Variables
        const adminWallet = 'nano_3m1pir3qb3ciyxsupsmo3zf1t3f1yccx8pjokj97tk9ya4oq333h69utzu4f';
        const entryFee = 0.02;  // The fee to join the lottery
        const participants = [];
        let userWallet = '';

        // Handle User Wallet Connection
        document.getElementById('walletForm').addEventListener('submit', function(event) {
            event.preventDefault();
            userWallet = document.getElementById('walletAddress').value;
            document.getElementById('userStatus').textContent = `Connected with wallet: ${userWallet}`;
            document.getElementById('joinLottery').disabled = false;
        });

        // Join Lottery
        document.getElementById('joinLottery').addEventListener('click', async function() {
            if (participants.length < 100) {
                // Send 0.02 Nano to Admin Wallet
                await sendNano(userWallet, adminWallet, entryFee);

                participants.push(userWallet);
                document.getElementById('lotteryStatus').textContent = `Participants: ${participants.length}/100`;

                // Once we hit 100 participants, start selecting a winner
                if (participants.length === 100) {
                    document.getElementById('lotteryStatus').textContent = 'Selecting winner...';

                    // Generate a random number using Chainlink VRF
                    generateRandomWinner(participants);
                }
            }
        });

        // Function to handle Chainlink VRF and select winner
        async function generateRandomWinner(participants) {
            try {
                // Here you would call Chainlink VRF to get a verifiable random number
                const randomIndex = await requestChainlinkVRF(participants.length);

                // Select the winner
                const winner = participants[randomIndex];
                document.getElementById('lotteryStatus').textContent = `Winner selected: ${winner}`;

                // Transfer funds to winner from admin wallet
                transferToWinner(winner, adminWallet);
            } catch (error) {
                console.error('Error in selecting a winner:', error);
                alert('Failed to select a winner.');
            }
        }

        // Request Chainlink VRF to get a secure random number
        async function requestChainlinkVRF(maxParticipants) {
            // Simulate Chainlink VRF API request - replace this with actual Chainlink VRF call
            return Math.floor(Math.random() * maxParticipants); // Placeholder for real VRF result
        }

        // Function to send Nano from User Wallet to Admin Wallet
        async function sendNano(fromWallet, toWallet, amount) {
            const rawAmount = nanoToRaw(amount);
            const payload = {
                action: "send",
                wallet: fromWallet,   // User's wallet ID
                source: fromWallet,   // Source wallet address
                destination: toWallet, // Admin's wallet
                amount: rawAmount
            };

            const response = await fetch('https://proxy.nanos.cc/proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.error) {
                console.error('Error sending Nano:', result.error);
                alert('Failed to send Nano.');
            } else {
                console.log(`Successfully sent ${amount} Nano!`);
            }
        }

        // Helper function to convert Nano amount to raw format
        function nanoToRaw(nanoAmount) {
            return BigInt(nanoAmount * Math.pow(10, 30)).toString();
        }

        // Function to send the total amount collected from the Admin Wallet to the winner
        async function transferToWinner(winnerWallet, adminWallet) {
            try {
                const adminBalance = await checkBalance(adminWallet);
                if (adminBalance > 0) {
                    await sendNano(adminWallet, winnerWallet, adminBalance);
                    alert(`Transferred ${adminBalance} Nano to the winner: ${winnerWallet}`);
                } else {
                    alert('No funds available to transfer.');
                }
            } catch (error) {
                console.error('Error transferring funds:', error);
                alert('Failed to transfer funds.');
            }
        }

        // Function to check wallet balance
        async function checkBalance(walletAddress) {
            const payload = {
                action: "account_balance",
                account: walletAddress
            };

            const response = await fetch('https://proxy.nanos.cc/proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.error) {
                console.error('Error checking balance:', result.error);
                return 0;
            }

            const balanceNano = rawToNano(result.balance);
            return balanceNano;
        }

        // Helper function to convert raw amount to Nano
        function rawToNano(rawAmount) {
            return parseFloat(rawAmount) / Math.pow(10, 30);
        }
    </script>
</body>
</html>
