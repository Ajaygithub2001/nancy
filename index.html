<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Lottery System with Virtual File System</title>
    <style>
        .emoji {
            font-size: 50px;
            text-align: center;
            margin: 20px 0;
        }
        .center-text {
            text-align: center;
        }
        .log-box {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid black;
            max-height: 200px;
            overflow-y: scroll;
        }
    </style>
</head>
<body>

    <!-- Big Laughing Emoji and Message -->
    <div class="emoji">ðŸ˜‚</div>
    <h1 class="center-text">We will give a reward to see this emoji for one person!</h1>
    
    <!-- Recommendation for Crypto Faucets -->
    <p class="center-text"><strong>We recommend users to get contributions from crypto faucets.</strong></p>

    <!-- User Wallet Connection -->
    <form id="walletForm" class="center-text">
        <label for="walletAddress">Enter your Nano wallet address:</label>
        <input type="text" id="walletAddress" name="walletAddress" required>
        <button type="submit">Connect</button>
    </form>

    <p id="userStatus" class="center-text">Please enter your wallet address to join the lottery.</p>

    <!-- Admin Wallet -->
    <p class="center-text">Admin Wallet Address: <strong>nano_3m1pir3qb3ciyxsupsmo3zf1t3f1yccx8pjokj97tk9ya4oq333h69utzu4f</strong></p>

    <!-- Lottery Info -->
    <button id="joinLottery" disabled>Join Lottery for 0.02 Nano</button>
    <p id="lotteryStatus" class="center-text">Participants: 0/100</p>

    <!-- Logs -->
    <h3 class="center-text">Participant Log</h3>
    <div id="log" class="log-box"></div>

    <h3 class="center-text">Winners Log</h3>
    <div id="winnersLog" class="log-box"></div>

    <script>
        // Global Variables
        const adminWallet = 'nano_3m1pir3qb3ciyxsupsmo3zf1t3f1yccx8pjokj97tk9ya4oq333h69utzu4f';
        const entryFee = 0.02;  // The fee to join the lottery
        let participants = [];
        let winners = [];
        let userWallet = '';

        // In-memory storage for virtual file system
        let participantsFile = [];
        let winnersFile = [];

        // Handle User Wallet Connection
        document.getElementById('walletForm').addEventListener('submit', function(event) {
            event.preventDefault();
            userWallet = document.getElementById('walletAddress').value;
            document.getElementById('userStatus').textContent = `Connected with wallet: ${userWallet}`;
            document.getElementById('joinLottery').disabled = false;
        });

        // Join Lottery
        document.getElementById('joinLottery').addEventListener('click', async function() {
            if (participants.length < 100) {
                // Simulating sending 0.02 Nano to Admin Wallet
                await sendNano(userWallet, adminWallet, entryFee);

                // Log participant wallet to virtual file
                participants.push(userWallet);
                participantsFile.push(`Wallet: ${userWallet}`);
                updateLog(participantsFile, "log");
                document.getElementById('lotteryStatus').textContent = `Participants: ${participants.length}/100`;

                // Once we hit 100 participants, start selecting a winner
                if (participants.length === 100) {
                    document.getElementById('lotteryStatus').textContent = 'Selecting winner...';

                    // Generate a random number using Chainlink VRF
                    generateRandomWinner(participants);
                }
            }
        });

        // Function to handle Chainlink VRF and select winner
        async function generateRandomWinner(participants) {
            try {
                // Simulate Chainlink VRF
                const randomIndex = await requestChainlinkVRF(participants.length);

                // Select the winner
                const winner = participants[randomIndex];
                document.getElementById('lotteryStatus').textContent = `Winner selected: ${winner}`;

                // Log winner to a separate virtual file
                winners.push(winner);
                winnersFile.push(`Winner: ${winner}`);
                updateLog(winnersFile, "winnersLog");

                // Transfer funds to winner from admin wallet (simulated)
                transferToWinner(winner, adminWallet);

                // Clear the participants file for the next round
                participants = [];
                participantsFile = [];
                updateLog(participantsFile, "log"); // Clear the log box

            } catch (error) {
                console.error('Error in selecting a winner:', error);
                alert('Failed to select a winner.');
            }
        }

        // Simulate Chainlink VRF to get a secure random number
        async function requestChainlinkVRF(maxParticipants) {
            return Math.floor(Math.random() * maxParticipants); // Placeholder for real VRF result
        }

        // Function to simulate sending Nano from User Wallet to Admin Wallet
        async function sendNano(fromWallet, toWallet, amount) {
            // Simulate transaction delay
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log(`Sent ${amount} Nano from ${fromWallet} to ${toWallet}`);
                    resolve();
                }, 1000);
            });
        }

        // Function to simulate transfer of funds to the winner
        async function transferToWinner(winnerWallet, adminWallet) {
            console.log(`Transferring funds from ${adminWallet} to winner ${winnerWallet}`);
            alert(`Winner ${winnerWallet} will receive all collected Nano!`);
        }

        // Update log box with participant or winner entries
        function updateLog(logData, logElementId) {
            const logElement = document.getElementById(logElementId);
            logElement.innerHTML = logData.map(entry => `<p>${entry}</p>`).join('');
        }
    </script>
</body>
</html>
